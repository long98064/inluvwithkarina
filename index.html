<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>aespa Premium Gallery</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <h1>AESPA GALLERY</h1>

    <div class="tabs-container" id="tabs"></div>

    <div class="section-title">Cập nhật mới (Instagram)</div>
    <div id="instagram-top-feed" class="insta-grid"></div>

    <hr class="divider">

    <div class="section-title">Bộ sưu tập ảnh (Pinterest)</div>
    <div id="pinterest-gallery" class="pin-grid"></div>

    <div id="lightbox" onclick="this.style.display='none'">
        <img id="lightbox-img" src="" alt="Ảnh phóng to">
    </div>

    <script>
        let globalData = null;

        async function init() {
            try {
                const response = await fetch('data.json');
                if (!response.ok) throw new Error("Không tìm thấy data.json");
                globalData = await response.json();
                
                renderTabs();
                
                if (globalData.profiles && globalData.profiles.length > 0) {
                    showFeed(globalData.profiles[0].username);
                }
            } catch (err) {
                console.error("Lỗi:", err);
            }
        }

        function renderTabs() {
            const tabsContainer = document.getElementById('tabs');
            tabsContainer.innerHTML = '';
            globalData.profiles.forEach((idol, index) => {
                const btn = document.createElement('button');
                btn.className = `tab-button ${index === 0 ? 'active' : ''}`;
                btn.innerText = idol.name;
                btn.onclick = () => {
                    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    showFeed(idol.username);
                };
                tabsContainer.appendChild(btn);
            });
        }

        // Hàm xử lý tải ảnh
        async function forceDownload(url, filename) {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = blobUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(blobUrl);
            } catch (error) {
                // Nếu bị chặn bởi CORS (thường gặp với Pinterest), mở ảnh trong tab mới để user lưu thủ công
                window.open(url, '_blank');
            }
        }

        function showFeed(username) {
            const instaFeed = document.getElementById('instagram-top-feed');
            const pinGallery = document.getElementById('pinterest-gallery');
            
            instaFeed.innerHTML = '';
            pinGallery.innerHTML = '';

            const idol = globalData.profiles.find(p => p.username === username);
            if (!idol) return;

            const instaPosts = idol.posts.filter(p => p.type !== 'pinterest').slice(0, 3);
            const pinPosts = idol.posts.filter(p => p.type === 'pinterest');

            instaPosts.forEach(post => {
                const div = document.createElement('div');
                div.className = 'insta-item';
                div.innerHTML = `<blockquote class="instagram-media" data-instgrm-permalink="${post.url}" data-instgrm-version="14"></blockquote>`;
                instaFeed.appendChild(div);
            });

            pinPosts.forEach((post, index) => {
                const div = document.createElement('div');
                div.className = 'pin-item';
                
                // Tạo ảnh
                const img = document.createElement('img');
                img.src = post.url;
                img.loading = "lazy";
                img.onclick = () => {
                    const lightbox = document.getElementById('lightbox');
                    const lightboxImg = document.getElementById('lightbox-img');
                    lightboxImg.src = post.url;
                    lightbox.style.display = 'flex';
                };

                // Tạo nút tải ảnh
                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'download-btn';
                downloadBtn.innerHTML = '⬇'; // Biểu tượng tải xuống
                downloadBtn.title = "Tải ảnh về máy";
                downloadBtn.onclick = (e) => {
                    e.stopPropagation(); // Ngăn sự kiện phóng to ảnh
                    forceDownload(post.url, `${idol.name}_aespa_${index}.jpg`);
                };

                div.appendChild(img);
                div.appendChild(downloadBtn);
                pinGallery.appendChild(div);
            });

            if (window.instgrm) {
                window.instgrm.Embeds.process();
            } else {
                const script = document.createElement('script');
                script.async = true;
                script.src = "//www.instagram.com/embed.js";
                document.body.appendChild(script);
            }
        }

        window.onload = init;
    </script>
</body>
</html>
