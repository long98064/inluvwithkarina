<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>aespa Premium Gallery</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- TRÌNH PHÁT NHẠC MINI -->
    <div class="music-player" id="music-player">
        <div class="music-info">
            <div class="music-disk" id="music-disk"></div>
            <div class="music-text">
                <span class="song-title" id="song-title">Whiplash</span>
                <span class="artist-name">aespa</span>
            </div>
        </div>
        <button class="play-btn" id="play-btn">▶</button>
        <audio id="bg-music" loop>
            <source id="music-source" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
        </audio>
    </div>

    <h1>AESPA GALLERY</h1>

    <div class="tabs-container" id="tabs"></div>

    <div class="section-title">Cập nhật mới (Instagram)</div>
    <div id="instagram-top-feed" class="insta-grid"></div>

    <hr class="divider">

    <div class="section-title">Bộ sưu tập ảnh (Pinterest)</div>
    <div id="pinterest-gallery" class="pin-grid"></div>

    <div id="lightbox" onclick="this.style.display='none'">
        <img id="lightbox-img" src="" alt="Ảnh phóng to">
    </div>

    <script>
        let globalData = null;

        // Định nghĩa bảng màu và bài hát cho từng Idol
        const idolThemes = {
            "Karina": {
                "gradient": "linear-gradient(135deg, #ff0055 0%, #7000ff 100%)", // Màu nguyên bản bạn thích
                "accent": "#ff0055",
                "glow": "rgba(255, 0, 85, 0.4)",
                "songTitle": "Whiplash",
                "songUrl": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" // Thay bằng link bài Whiplash
            },
            "Winter": {
                "gradient": "linear-gradient(135deg, #00d4ff 0%, #ffffff 100%)",
                "accent": "#00d4ff",
                "glow": "rgba(0, 212, 255, 0.4)",
                "songTitle": "Supernova",
                "songUrl": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" // Thay bằng link bài Supernova
            }
        };

        const music = document.getElementById('bg-music');
        const musicSource = document.getElementById('music-source');
        const playBtn = document.getElementById('play-btn');
        const songTitleDisplay = document.getElementById('song-title');
        const disk = document.getElementById('music-disk');
        let isPlaying = false;

        playBtn.onclick = () => {
            if (isPlaying) {
                music.pause();
                playBtn.innerText = '▶';
                disk.classList.remove('rotating');
            } else {
                music.play();
                playBtn.innerText = '⏸';
                disk.classList.add('rotating');
            }
            isPlaying = !isPlaying;
        };

        async function init() {
            try {
                const response = await fetch('data.json');
                if (!response.ok) throw new Error("Không tìm thấy data.json");
                globalData = await response.json();
                renderTabs();
                if (globalData.profiles && globalData.profiles.length > 0) {
                    showFeed(globalData.profiles[0].username);
                }
            } catch (err) { console.error(err); }
        }

        function applyThemeAndMusic(idolName) {
            const theme = idolThemes[idolName] || idolThemes["Karina"];
            const root = document.documentElement;
            
            // 1. Đổi màu giao diện
            root.style.setProperty('--primary-gradient', theme.gradient);
            root.style.setProperty('--accent', theme.accent);
            root.style.setProperty('--glow-color', theme.glow);

            // 2. Đổi bài hát
            if (songTitleDisplay.innerText !== theme.songTitle) {
                songTitleDisplay.innerText = theme.songTitle;
                musicSource.src = theme.songUrl;
                music.load(); // Tải lại file nhạc mới
                
                // Nếu đang phát thì tiếp tục phát bài mới luôn
                if (isPlaying) {
                    music.play();
                }
            }
        }

        function renderTabs() {
            const tabsContainer = document.getElementById('tabs');
            tabsContainer.innerHTML = '';
            globalData.profiles.forEach((idol, index) => {
                const btn = document.createElement('button');
                btn.className = `tab-button ${index === 0 ? 'active' : ''}`;
                btn.innerText = idol.name;
                btn.onclick = () => {
                    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    showFeed(idol.username);
                };
                tabsContainer.appendChild(btn);
            });
        }

        async function forceDownload(url, filename) {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const a = document.createElement('a');
                a.href = window.URL.createObjectURL(blob);
                a.download = filename;
                a.click();
            } catch { window.open(url, '_blank'); }
        }

        function showFeed(username) {
            const idol = globalData.profiles.find(p => p.username === username);
            if (!idol) return;

            applyThemeAndMusic(idol.name);

            const instaFeed = document.getElementById('instagram-top-feed');
            const pinGallery = document.getElementById('pinterest-gallery');
            instaFeed.innerHTML = ''; 
            pinGallery.innerHTML = '';

            const instaPosts = idol.posts.filter(p => p.type !== 'pinterest').slice(0, 3);
            const pinPosts = idol.posts.filter(p => p.type === 'pinterest');

            instaPosts.forEach(post => {
                const div = document.createElement('div');
                div.className = 'insta-item';
                div.innerHTML = `<blockquote class="instagram-media" data-instgrm-permalink="${post.url}" data-instgrm-version="14"></blockquote>`;
                instaFeed.appendChild(div);
            });

            pinPosts.forEach((post, index) => {
                const div = document.createElement('div');
                div.className = 'pin-item';
                div.innerHTML = `<img src="${post.url}" loading="lazy"><button class="download-btn">⬇</button>`;
                div.querySelector('img').onclick = () => {
                    document.getElementById('lightbox-img').src = post.url;
                    document.getElementById('lightbox').style.display = 'flex';
                };
                div.querySelector('.download-btn').onclick = (e) => {
                    e.stopPropagation();
                    forceDownload(post.url, `${idol.name}_${index}.jpg`);
                };
                pinGallery.appendChild(div);
            });

            if (window.instgrm) window.instgrm.Embeds.process();
            else {
                const s = document.createElement('script'); s.async = true; s.src = "//www.instagram.com/embed.js";
                document.body.appendChild(s);
            }
        }
        window.onload = init;
    </script>
</body>
</html>
